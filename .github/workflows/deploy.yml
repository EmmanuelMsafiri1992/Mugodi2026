name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          command_timeout: 30m
          script: |
            set -e

            REPOPATH=/home/indegnnk/mugodirepo
            DEPLOYPATH=/home/indegnnk/mugodi.com

            echo "=========================================="
            echo "Starting deployment: $(date)"
            echo "=========================================="

            # Fix git safe directory issue
            git config --global --add safe.directory $REPOPATH

            # Ensure repo exists, clone if not
            if [ ! -d "$REPOPATH/.git" ]; then
              echo ">>> Cloning repository..."
              rm -rf $REPOPATH
              git clone https://github.com/EmmanuelMsafiri1992/Mugodi2026.git $REPOPATH
            fi

            # Pull latest changes
            echo ">>> Pulling latest changes..."
            cd $REPOPATH
            git fetch origin
            git reset --hard origin/main

            # Sync files to deploy path (exclude sensitive files)
            echo ">>> Syncing files..."
            /bin/rsync -av --delete \
              --exclude='.git' \
              --exclude='.env' \
              --exclude='node_modules' \
              --exclude='client/node_modules' \
              --exclude='server/node_modules' \
              --exclude='client/dist' \
              $REPOPATH/ $DEPLOYPATH/

            # Set permissions
            echo ">>> Setting permissions..."
            cd $DEPLOYPATH
            chown -R indegnnk:indegnnk $DEPLOYPATH

            # Install client dependencies and build React app
            echo ">>> Building React frontend..."
            cd $DEPLOYPATH/client
            npm install --silent
            npm run build

            # Install server dependencies
            echo ">>> Installing server dependencies..."
            cd $DEPLOYPATH/server
            npm install --silent --production

            # Create uploads directory if it doesn't exist
            mkdir -p $DEPLOYPATH/server/uploads

            # Check if PM2 is installed, install if not
            if ! command -v pm2 &> /dev/null; then
              echo ">>> Installing PM2 globally..."
              npm install -g pm2
            fi

            # Stop existing PM2 process if running
            echo ">>> Restarting Node.js server..."
            cd $DEPLOYPATH/server
            pm2 stop mugodi-server 2>/dev/null || true
            pm2 delete mugodi-server 2>/dev/null || true

            # Start the server with PM2
            pm2 start server.js --name mugodi-server --env production

            # Save PM2 process list
            pm2 save

            # Set final permissions
            echo ">>> Setting final permissions..."
            chmod -R 755 $DEPLOYPATH
            chown -R indegnnk:indegnnk $DEPLOYPATH

            # Health check
            echo ">>> Running health check..."
            sleep 3
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://mugodi.com)
            if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "302" ]; then
              echo "Site is responding with HTTP $HTTP_STATUS"
            else
              echo "Site returned HTTP $HTTP_STATUS - please check manually"
            fi

            # Check API health
            API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://mugodi.com/api/health 2>/dev/null || echo "000")
            echo "API health check: HTTP $API_STATUS"

            echo "=========================================="
            echo "Deployment completed: $(date)"
            echo "=========================================="
